# =====================================================
# Proxy reverso e segurança para o ambiente EHS
# Domínios: apiehs.apexis.cloud, ehs.apexis.cloud, apexis.cloud
# =====================================================

# -------------------------------
# API EHS
# -------------------------------
apiehs.apexis.cloud {
    reverse_proxy ehs-api:8080

    # Cabeçalhos de segurança + CORS
    header {
        # Segurança básica
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Frame-Options "DENY"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
        X-XSS-Protection "1; mode=block"
    }

    # Logging
    log {
        output file /data/logs/apiehs-access.log
        format json
    }
}

# Redireciona HTTP → HTTPS automaticamente
http://apiehs.apexis.cloud {
    redir https://apiehs.apexis.cloud{uri} permanent
}

# -------------------------------
# EHS Frontend
# -------------------------------
ehs.apexis.cloud {
    reverse_proxy ehs-smart:80

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Frame-Options "DENY"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
        X-XSS-Protection "1; mode=block"
    }

    log {
        output file /data/logs/ehs-access.log
        format json
    }
}

http://ehs.apexis.cloud {
    redir https://ehs.apexis.cloud{uri} permanent
}

# -------------------------------
# Portal Web Apexis
# -------------------------------
apexis.cloud {
    reverse_proxy apexis-site:82

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Frame-Options "DENY"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
        X-XSS-Protection "1; mode=block"
    }

    log {
        output file /data/logs/apexis-access.log
        format json
    }
}

http://apexis.cloud {
    redir https://apexis.cloud{uri} permanent
}